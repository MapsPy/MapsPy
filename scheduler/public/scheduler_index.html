<!DOCTYPE html>
<html>
  <head>
    <link href="/static/css/style.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() 
      {
        //get all process nodes
        $.ajax(
        {
          url:"/process_node",
          datatype: "text",
          success: function(data) 
          {
            var $table = $("#process_node_table");
            var nodes = $.parseJSON(data);
            nodes.forEach( function(item) 
            {
              var $tr = $("<tr id='data_entry'>");
              $tr.append( $("<td>").text(item.ComputerName));
              $tr.append( $("<td>").text(item.NumThreads));
              $tr.append( $("<td>").text(item.Status));
              $tr.append( $("<td>").text(item.Heartbeat));
              $table.append( $tr);
            })
          }
        });
        //get all jobs
        $.ajax(
        {
          url:"/job",
          datatype: "text",
          success: function(data) 
          {
            var $table = $("#job_table");
            var jobs = $.parseJSON(data);
            jobs.forEach( function(item) 
            {
              var $tr = $("<tr id='data_entry'>");
              $tr.append( $("<td>").text(item.Id));
              $tr.append( $("<td>").text(item.DataPath));
			  if(item.Status == 0)
              {
                $tr.append( $("<td>").text("Waiting"));
              }
			  if(item.Status == 1)
              {
                $tr.append( $("<td>").text("Processing"));
              }
			  if(item.Status == 2)
              {
                $tr.append( $("<td>").text("Error Occured"));
              }
			  if(item.Status == 3)
              {
                $tr.append( $("<td>").text("Completed"));
              }
              $table.append( $tr);
            })
          }
        });

      $('.header').click(function(){
        $(this).toggleClass('expand').nextUntil('tr.header').slideToggle(100);
      });

      jQuery('.tabs .tab-links a').on('click', function(e)  {
        var currentAttrValue = jQuery(this).attr('href');
 
        // Show/Hide Tabs
        jQuery('.tabs ' + currentAttrValue).show().siblings().hide();
 
        // Change/remove current tab to active
        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
 
        e.preventDefault();
    });

      //Poll every 3 seconds
      setInterval(function()
      {
        $.ajax({ url: "/process_node", success: function(data)
        {
          var $table = $("#process_node_table");
          $table.empty();
          var $trCn = $('<tr class="header expand"> <th colsnap="4"> <span class="sign"> </snap> Computer Name  </th> </tr>');
          $table.append($trCn);
          var nodes = $.parseJSON(data);
          nodes.forEach( function(item) 
          {
            var $tr = $("<tr id='data_entry'>");
            $tr.append( $("<td>").text(item.ComputerName));
            $tr.append( $("<td>").text(item.NumThreads));
            $tr.append( $("<td>").text(item.Status));
            $tr.append( $("<td>").text(item.Heartbeat));
            $table.append( $tr);
          })
        }, dataType: "json"});
        $.ajax({ url: "/job", success: function(data)
        {
          var $table = $("#job_table");
          $table.empty();
          var $trCn = $('<tr class="header expand"> <th colsnap="4"> <span class="sign"> </snap> Jobs  </th> </tr>');
          $table.append($trCn);
          var jobs = $.parseJSON(data);
          jobs.forEach( function(item) 
          {
            var $tr = $("<tr id='data_entry'>");
            $tr.append( $("<td>").text(item.Id));
            $tr.append( $("<td>").text(item.DataPath));
            $tr.append( $("<td>").text(item.Status));
            $table.append( $tr);
          })
        }, dataType: "json"});
      }, 3000);


         $("#Btn-Submit-Job").click(function(e) {
          var procMask = 0;
          if ($('#analysis-type-a')[0].checked == true)
          {
            procMask += 1
          }
          if ($('#analysis-type-b')[0].checked == true)
          {
            procMask += 2
          }
          if ($('#analysis-type-c')[0].checked == true)
          {
            procMask += 4
          }
          if ($('#analysis-type-d')[0].checked == true)
          {
            procMask += 8
          }
          if ($('#analysis-type-e')[0].checked == true)
          {
            procMask += 16
          }
          $.ajax(
          {
            type: 'POST',
            url:"/job",
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({'MaxFilesToProc': 1, 'ProcMask': procMask, 'BeamLine': '2-ID-E', 'DataPath': $("#DataPath").val(), 'Version': '1.00', 'Standards': '', 'DetectorToStartWith': 0, 'XRF_Bin': 0, 'MaxLinesToProc': 11, 'DetectorElements': parseInt($("#DetectorElements").val(), 10), 'XANES_Scan': 0, 'NNLS': 0, 'QuickAndDirty': 0, 'Status': 0, 'Priority': 5, 'StartProcTime': 0, 'FinishProcTime': 0}),
            datatype: "json"
          }).done(function(d)
                   { 
              alert("added job");
                   });
         });
/*
         $("#replace-string").click(function(e) {
           $.ajax({
              type: "PUT",
              url: "/generator",
              data: {"another_string": $("#the-string").val()}
           })
           .done(function() {
              alert("Replaced!");
           });
           e.preventDefault();
         });

         $("#delete-string").click(function(e) {
           $.ajax({
              type: "DELETE",
              url: "/generator"
           })
           .done(function() {
              $("#the-string").hide();
           });
           e.preventDefault();
         });
*/


       });
     </script>
   </head>
   <body>
     <div id="process_nodes_div">
         <table id="process_node_table">
         <!--  <tr class="header expand"> <th> <span class="sign">  <td> Computer Name </td> <td> Number of Threads </td> <td> Status </td> <td> Heartbeat </td> </span>  </th> </tr> -->
           <tr class="header expand"> <th colsnap="4"> <span class="sign"> </snap> Computer Name  </th> </tr>
           
         </table>
     </div>
     <div id="jobs_div">
         <table id="job_table">
           <tr class="header expand"> <th colsnap="4"> <span class="sign"> </snap> Jobs  </th> </tr>
           
         </table>
     </div>


<div class="tabs">
    <ul class="tab-links">
        <li class="active"><a href="#tab1">2-ID-E</a></li>
        <li><a href="#tab2">GSE CARS</a></li>
    </ul>
 
    <div class="tab-content">
        <div id="tab1" class="tab active">
            <p>2-ID-E</p>

        <!--   <form> -->
             <fieldset>
               <legend>Job Information:</legend>
               Job Path:
               <input type="text" id="DataPath" value="/">
               <br>
               <input type="checkbox" id="analysis-type-a" value="A">A<br>
               <input type="checkbox" id="analysis-type-b" value="B">B<br>
               <input type="checkbox" id="analysis-type-c" value="C">C<br>
               <input type="checkbox" id="analysis-type-d" value="D">D<br>
               <input type="checkbox" id="analysis-type-e" value="E">E<br>
               Total Number of Detectors <br>
               <input type="text" id="DetectorElements" value="4">
<!--
            version = 0
            total_number_detectors = 1
            max_no_processors_files = 1
            max_no_processors_lines = 1
            write_hdf = 0
            quick_dirty = 0
            xrf_bin = 0
            nnls = 0
            xanes_scan = 0
            detector_to_start_with = 0
            #default beamline to use for now is 2-id-e , we will change this in the future
-->
               <br><br>
               <button id="Btn-Submit-Job">Submit Job</button>
             </fieldset>
      <!--     </form> -->
         </div>
 
        <div id="tab2" class="tab">
            <p>GSE CARS</p>
            <p>Submit Job</p>
        </div>
 
    </div>
</div>
<!--
     <input type="text" value="8" name="length" />
     <button id="generate-string">Give it now!</button>
     <div id="the-string">
         <input type="text" />
         <button id="replace-string">Replace</button>
         <button id="delete-string">Delete it</button>
     </div>
-->
   </body>
</html>
