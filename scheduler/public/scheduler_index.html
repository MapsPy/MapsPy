<!DOCTYPE html>
<html>
  <head>
    <link href="/static/css/style.css" rel="stylesheet">
    <script src="/static/jquery/jquery-2.0.3.min.js"></script> 
    <script type="text/javascript">
    $(document).ready(function() 
    {
        function get_process_nodes()
        {
            //get all process nodes
            $.ajax(
            {
                url:"/process_node",
                type: "GET",
                datatype: "json",
                success: function(data) 
                {
                    var $table = $("#data_process_nodes");
                    $table.empty();
                    var nodes = $.parseJSON(data);
                    nodes.forEach( function(item) 
                    {
                        var $tr = $("<tr id='data_entry'>");
                        $tr.append( $("<td>").text(item.ComputerName));
                        $tr.append( $("<td>").text(item.NumThreads));
                        $tr.append( $("<td>").text(item.Status));
                        $tr.append( $("<td>").text(item.Heartbeat));
                        $table.append( $tr);
                    });
                }
            });
        }
       
        function job_get_img_list($td, job_path)
        {
            $.ajax(
            {
                url: '/get_spectrum_image_list',
                type: 'POST',
                datatype: "json",
                data: {'job_path': job_path},
                success: function(data) 
                {
                    //alert(data);
                    var image_links = $.parseJSON(data);
                    var str = "";
                    image_links.forEach( function(img_link) 
                    {
                        str += '<p id=img_link>'+img_link+'</p>';
                    });
                    $td.text(str);
                }
            });           
        }
 
        function job_parse_status($tr, $item)
        {
            if($item.Status === 0)
            {
              $tr.append( $("<td>").text("Waiting"));
            }
            if($item.Status === 1)
            {
              $tr.append( $("<td>").text("Processing"));
            }
            if($item.Status === 2)
            {
              $tr.append( $("<td>").text("Completed"));
            }
            if($item.Status > 2)
            {
              $tr.append( $("<td>").text("Error Occured"));
            }
        }
        
        function job_parse_proc_mask($tr, $item)
        {
            var $procMaskStr = "";
            var $has_b = false;
            if( ($item.ProcMask & 1) === 1)
            {
                $procMaskStr += "A\n";
            }
            if( ($item.ProcMask & 2) === 2)
            {
                $procMaskStr += "B\n";
                $has_b = true;
            }
            if( ($item.ProcMask & 4) === 4)
            {
                $procMaskStr += "C\n";
            }
            if( ($item.ProcMask & 8) === 8)
            {
                $procMaskStr += "D\n";
            }
            if( ($item.ProcMask & 16) === 16)
            {
                $procMaskStr += "E";
            }
            $tr.append( $("<td>").text($procMaskStr));
            if($has_b === true)
            {
                var $td =  $("<td>");
                $tr.append( $td );
                //job_get_img_list($td, $item.DataPath);
            }
            else
            {
                $tr.append( $("<td>").text('N/A'));    
            }
        }
       
        function get_jobs(c_url, c_table)
        {
            $.ajax(
            {
                url:c_url,
                type: 'GET',
                datatype: "json",
                success: function(data) 
                {
                    var $table = $(c_table);
                    $table.empty();
                    var jobs = $.parseJSON(data);
                    jobs.forEach( function(item) 
                    {
                        var $tr = $("<tr id='data_entry'>");
                        $tr.append( $("<td>").text(item.Id));
                        $tr.append( $("<td>").text(item.DataPath));
                        job_parse_status($tr, item);
                        job_parse_proc_mask($tr, item);
                        $table.append( $tr);
                    });
                }
            });
        }
        
        setInterval(function()
        {
            get_process_nodes();
            get_jobs("/get_all_unprocessed_jobs", "#data_unprocessed_jobs");
            get_jobs("/get_all_processing_jobs", "#data_processing_jobs");
            get_jobs("/get_all_finished_jobs", "#data_finished_jobs");
        }, 3000);
     
        get_process_nodes();
        get_jobs("/get_all_unprocessed_jobs", "#data_unprocessed_jobs");
        get_jobs("/get_all_processing_jobs", "#data_processing_jobs");
        get_jobs("/get_all_finished_jobs", "#data_finished_jobs");
     
        $('.header').click(function(){
            $(this).toggleClass('expand').nextUntil('tr.header').slideToggle(100);
        });

        jQuery('.tabs .tab-links a').on('click', function(e)  
        {
            var currentAttrValue = jQuery(this).attr('href');
            // Show/Hide Tabs
            jQuery('.tabs ' + currentAttrValue).show().siblings().hide();
            // Change/remove current tab to active
            jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
            e.preventDefault();
        });

        function gen_job_mask()
        {
            var procMask = 0;
            if ($('#analysis-type-a')[0].checked === true)
            {
                procMask += 1;
            }
            if ($('#analysis-type-b')[0].checked === true)
            {
                procMask += 2;
            }
            if ($('#analysis-type-c')[0].checked === true)
            {
                procMask += 4;
            }
            if ($('#analysis-type-d')[0].checked === true)
            {
                procMask += 8;
            }
            if ($('#analysis-type-e')[0].checked === true)
            {
                procMask += 16;
            }
            return procMask;
        }

        $("#Btn-Submit-Job").click(function(e) 
        {
            var $procMask = gen_job_mask();
            $.ajax(
            {
                type: 'POST',
                url:"/job",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({'MaxFilesToProc': 1,
                    'ProcMask': $procMask,
                    'BeamLine': '2-ID-E',
                    'DataPath': $("#DataPath").val(),
                    'Version': '1.00',
                    'Standards': '',
                    'DetectorToStartWith': 0,
                    'XRF_Bin': 0,
                    'MaxLinesToProc': 11,
                    'DetectorElements': parseInt($("#DetectorElements").val(), 10),
                    'XANES_Scan': 0,
                    'NNLS': 0,
                    'QuickAndDirty': 0,
                    'Status': 0,
                    'Priority': 5,
                    'StartProcTime': 0,
                    'FinishProcTime': 0}),
                datatype: "json"
            }).done(function(d)
            { 
                alert("added job");
            });
        });
    });
    </script>
    <title> MapsPy Scheduler </title>
  </head>
  <body>
     <div id="process_nodes_div">
         <table id="process_node_table">
         <tr class="header expand"> <th> <span class="sign"> </span> Computer Name  </th> </tr>
         <tbody id="data_process_nodes"/>
         </table>
     </div>
     <div id="jobs_div">
         <table id="table_unprocessed_jobs">
           <tr class="header expand"> <th> <span class="sign"> </span> Waiting Jobs </th> </tr>
           <tbody id="data_unprocessed_jobs"/>
         </table>
         <table id="table_processing_jobs">
           <tr class="header expand"> <th> <span class="sign"> </span> Processing Jobs </th> </tr>
           <tbody id="data_processing_jobs"/>
         </table>
          <table id="table_finished_jobs">
           <tr class="header expand"> <th> <span class="sign"> </span> Finished Jobs  </th> </tr>
           <tbody id="data_finished_jobs"/>
         </table>
     </div>


    <div class="tabs">
    <ul class="tab-links">
        <li class="active"><a href="#tab1">2-ID-E</a></li>
        <li><a href="#tab2">GSE CARS</a></li>
    </ul>
 
    <div class="tab-content">
        <div id="tab1" class="tab active">
            <p>2-ID-E</p>

        <!--   <form> -->
             <fieldset>
               <legend>Job Information:</legend>
               Job Path:
               <input type="text" id="DataPath" value="/"> <button id='Brouse_2IDE'>Browse</button>
               <br>
               <input type="checkbox" id="analysis-type-a" value="A">A<br>
               <input type="checkbox" id="analysis-type-b" value="B">B<br>
               <input type="checkbox" id="analysis-type-c" value="C">C<br>
               <input type="checkbox" id="analysis-type-d" value="D">D<br>
               <input type="checkbox" id="analysis-type-e" value="E">E<br>
               Total Number of Detectors <br>
               <input type="text" id="DetectorElements" value="4">
<!--
            version = 0
            total_number_detectors = 1
            max_no_processors_files = 1
            max_no_processors_lines = 1
            write_hdf = 0
            quick_dirty = 0
            xrf_bin = 0
            nnls = 0
            xanes_scan = 0
            detector_to_start_with = 0
            #default beamline to use for now is 2-id-e , we will change this in the future
-->
               <br><br>
               <button id="Btn-Submit-Job">Submit Job</button>
             </fieldset>
      <!--     </form> -->
         </div>
 
        <div id="tab2" class="tab">
            <p>GSE CARS</p>
            <p>Submit Job</p>
        </div>
 
    </div>
    </div>

  </body>
</html>
