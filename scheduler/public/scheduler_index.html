<!DOCTYPE html>
<html>
  <head>
    <link href="/static/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/data_tables/css/jquery.dataTables.css">
    <link rel="stylesheet" href="/static/jstree_dist/themes/default/style.min.css" />
    <script src="/static/jquery/jquery-2.0.3.min.js"></script> 
    <script src="/static/jstree_dist/jstree.min.js"></script> 
    <script src="/static/data_tables/js/jquery.dataTables.js"></script> 
    <script src="/static/notify.min.js"></script> 
    <script type="text/javascript">
    $(document).ready(function() 
    {
        function get_process_nodes()
        {
            //get all process nodes
            $.ajax(
            {
                url:"/process_node",
                type: "GET",
                datatype: "json",
                success: function(data) 
                {
                    var $table = $("#process_node_table");
                    $table.empty();
                    var $tbody = $table.append("<tbody>");
                    var nodes = $.parseJSON(data);
                    nodes.forEach( function(item) 
                    {
                        var $tr = $("<tr id='data_entry'>");
                        $tr.append( $("<td>").text(item.ComputerName));
                        $tr.append( $("<td>").text(item.NumThreads));
                        $tr.append( $("<td>").text(item.Status));
                        $tr.append( $("<td>").text(item.Heartbeat));
                        $tbody.append( $tr);
                    });
                }
            });
        }

        function popup_get_img_list($td, job_path)
        {
            var $url = '/get_output_list?path='+$(this).attr('link'); 
			window.open($url);
        }

        function job_parse_status($tr, $item)
        {
            if($item.Status === 0)
            {
              $tr.append( $("<td>").text("Waiting"));
            }
            if($item.Status === 1)
            {
              $tr.append( $("<td>").text("Processing"));
            }
            if($item.Status === 2)
            {
              $tr.append( $("<td>").text("Completed"));
            }
            if($item.Status > 2)
            {
              $tr.append( $("<td>").text("Error Occured"));
            }
        }
        
        function job_parse_proc_mask($tr, $item)
        {
            var $procMask = $('<ul>');
            var $has_b = false;
            if( ($item.ProcMask & 1) === 1)
            {
                $procMask.append( $('<li>').text('A') );
            }
            if( ($item.ProcMask & 2) === 2)
            {
                $procMask.append( $('<li>').text('B') );
                //$procMaskStr += "B\n";
                $has_b = true;
            }
            if( ($item.ProcMask & 4) === 4)
            {
                $procMask.append( $('<li>').text('C') );
                //$procMaskStr += "C\n";
            }
            if( ($item.ProcMask & 8) === 8)
            {
                $procMask.append( $('<li>').text('D') );
                //$procMaskStr += "D\n";
            }
            if( ($item.ProcMask & 16) === 16)
            {
                $procMask.append( $('<li>').text('E') );
                //$procMaskStr += "E";
            }
            //$tr.append( $("<td>").text($procMaskStr));
            $tr.append( $("<td>").append($procMask));
			/*
            var $href = $("<a>");
            $href.click('href', 'get_output_list?job_path='+);
            $tr.append( $("<td>").append( $href ) );
			*/
            /*
            if($has_b === true)
            {
                var $td =  $("<td>");
                $tr.append( $td );
                job_get_img_list($td, $item.DataPath);
            }
            else
            {
                $tr.append( $("<td>").text('N/A'));    
            }
            */
        }
       
       function job_proc_mask_to_str($ProcMask)
        {
            if( ($ProcMask & 1) === 1)
            {
                return 'A';
            }
            if( ($ProcMask & 2) === 2)
            {
                return 'B';
            }
            if( ($ProcMask & 4) === 4)
            {
                return 'C';
            }
            if( ($ProcMask & 8) === 8)
            {
                return 'D';
            }
            if( ($ProcMask & 16) === 16)
            {
                return 'E';
            }
        }
       
        function get_jobs(c_url, c_table)
        {
            $.ajax(
            {
                url:c_url,
                type: 'GET',
                datatype: "json",
                success: function(data) 
                {
                    var $table = $(c_table);
                    $table.empty();
                    var jobs = $.parseJSON(data);
                    jobs.forEach( function(item) 
                    {
                        var $tr = $("<tr id='data_entry'>");
                        $tr.append( $("<td>").text(item.Id));
                        $tr.append( $("<td>").text(item.DataPath));
                        job_parse_status($tr, item);
                        job_parse_proc_mask($tr, item);
                        var $href = $("<a>");
                        $href.attr('href', 'get_output_list?job_path='+item.DataPath);
                        $href.text("Output Dir");
                        $tr.append( $("<td>").append( $href ) );
                        $table.append( $tr);
                    });
                }
            });
        }
        

     
        //get_process_nodes();
        //get_jobs("/get_all_unprocessed_jobs", "#data_unprocessed_jobs");
        //get_jobs("/get_all_processing_jobs", "#data_processing_jobs");
        //get_jobs("/get_all_finished_jobs", "#data_finished_jobs");
     
        $('.header').click(function()
        {
            $(this).parent().parent().next('tbody').slideToggle(100);
        });

        jQuery('.tabs .tab-links a').on('click', function(e)  
        {
            var currentAttrValue = jQuery(this).attr('href');
            // Show/Hide Tabs
            jQuery('.tabs ' + currentAttrValue).show().siblings().hide();
            // Change/remove current tab to active
            jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
            e.preventDefault();
        });

        function gen_job_mask()
        {
            var procMask = 0;
            if ($('#analysis-type-a')[0].checked === true)
            {
                procMask += 1;
            }
            if ($('#analysis-type-b')[0].checked === true)
            {
                procMask += 2;
            }
            if ($('#analysis-type-c')[0].checked === true)
            {
                procMask += 4;
            }
            if ($('#analysis-type-d')[0].checked === true)
            {
                procMask += 8;
            }
            if ($('#analysis-type-e')[0].checked === true)
            {
                procMask += 16;
            }
            return procMask;
        }

        function get_check_value(name)
        {
            var val = 0;
            if( $(name)[0].checked)
            {
                val = 1;
            }
            return val;
        }
        
        $("#Btn-Submit-Job").click(function(e) 
        {
            var $procMask = gen_job_mask();
            var $quickNdirty = get_check_value('#option-quick-and-dirty');
            var $xrfbin = get_check_value('#option-xrf-bin');
            var $nnls = get_check_value('#option-nnls');
            var $xanes = get_check_value('#option-xanes');
            
            $.ajax(
            {
                type: 'POST',
                url:"/job",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({'MaxFilesToProc': 1,
                    'ProcMask': $procMask,
                    'BeamLine': '2-ID-E',
                    'DataPath': $("#DataPath").val(),
                    'Version': '1.00',
                    'Standards': '',
                    'DetectorToStartWith': 0,
                    'XRF_Bin': $xrfbin,
                    'MaxLinesToProc': 11,
                    'DetectorElements': parseInt($("#option-detector-elements").val(), 10),
                    'XANES_Scan': $xanes,
                    'NNLS': $nnls,
                    'QuickAndDirty': $quickNdirty,
                    'Status': 0,
                    'Priority': 5,
                    'StartProcTime': 0,
                    'FinishProcTime': 0}),
                datatype: "json"
            }).done(function(d)
            { 
                //alert("added job");
                $.notify("Queued Job: "+$("#DataPath").val(), "success");
            });
        });
        
        $('.overlay').hide();
        
        $('#Btn-Select-Dir').click(function(e)
        {
            $('.overlay').hide();
            var $tree = $('#jstree').jstree(true);
            var $sel = $tree.get_selected();
            $('#DataPath').val( $sel[0] );
        });
        
        $("#Btn-Brouse-2IDE").click(function(e) 
        {
            $.ajax(
            {
                type: 'POST',
                url:"/get_dataset_dirs_list",
                data: {'job_root': '2ide', 'depth': 0},
                datatype: "json",
                success: function(data) 
                {
                    var $ul = $('#browse-jobs-list');
                    var $job_dirs = $.parseJSON(data);
                    $('#jstree').jstree($job_dirs);
                    $('.overlay').show();
                }
            });
        });

        function format_job_details ( d ) 
        {
            return  'Id: '+d.Id+'<br>'+
                    'DataPath: '+d.DataPath+'<br>'+
                    'Processing Type: '+job_proc_mask_to_str(d.ProcMask)+'<br>'+
                    'Priority: '+d.Priority+'<br>'+
                    'DetectorElements: '+d.DetectorElements+'<br>'+
                    'XANES_Scan: '+d.XANES_Scan+'<br>'+
                    'Version: '+d.Version+'<br>'+
                    'NNLS: '+d.NNLS+'<br>'+
                    'XANES_Scan: '+d.XANES_Scan+'<br>'+
                    'BeamLine: '+d.BeamLine+'<br>'+
                    '<a href=/get_output_list?job_path='+d.DataPath+'>Output Directory</a>';
        }

        var $pn_table = $("#process_node_table").DataTable(
        {
            //"processing": true,
            //"serverSide": true,
            "ajax": "/process_node",
            "columns": [
            {
                "class":          "details-control",
                "orderable":      false,
                "data":           null,
                "defaultContent": ""
            },
            { "data": "ComputerName" },
            { "data": "Status" },
            { "data": "NumThreads" },
            { "data": "Heartbeat" }
            ],
            "order": [[1, 'asc']]
        });
        
        var $queued_table = $("#table_unprocessed_jobs").DataTable(
        {
            "ajax": "/get_all_unprocessed_jobs",
            "columns": [
            {
                "class":          "details-control",
                "orderable":      false,
                "data":           null,
                "defaultContent": ""
            },
            { "data": "Id" },
            { "data": "DataPath" },
            { "data": "Status" },
            { "data": "ProcMask" },
            ],
            "order": [[1, 'desc']]
        });
        
        var $processing_table = $("#table_processing_jobs").DataTable(
        {
            "ajax": "/get_all_processing_jobs",
            "columns": [
            {
                "class":          "details-control",
                "orderable":      false,
                "data":           null,
                "defaultContent": ""
            },
            { "data": "Id" },
            { "data": "DataPath" },
            { "data": "Status" },
            { "data": "ProcMask" },
            ],
            "order": [[1, 'desc']]
        });
        
        var $finished_table = $("#table_finished_jobs").DataTable(
        {
            "ajax": "/get_all_finished_jobs",
            "columns": [
            {
                "class":          "details-control",
                "orderable":      false,
                "data":           null,
                "defaultContent": ""
            },
            { "data": "Id" },
            { "data": "DataPath" },
            { "data": "Status" },
            { "data": "ProcMask" },
            ],
            "order": [[1, 'desc']]
        });
        
        setInterval(function()
        {
            //get_process_nodes();
            //get_jobs("/get_all_unprocessed_jobs", "#data_unprocessed_jobs");
            //get_jobs("/get_all_processing_jobs", "#data_processing_jobs");
            //get_jobs("/get_all_finished_jobs", "#data_finished_jobs");
            $pn_table.ajax.reload();
            $queued_table.ajax.reload();
            $processing_table.ajax.reload();
            $finished_table.ajax.reload();
        }, 3000);
	
        var detailRows = [];
        $('#table_finished_jobs tbody').on( 'click', 'tr td.details-control', function () 
        {
            var tr = $(this).closest('tr');
            var row = $finished_table.row( tr );
            var idx = $.inArray( tr.attr('id'), detailRows );

            if ( row.child.isShown() ) 
            {
                tr.removeClass( 'details' );
                row.child.hide();

                // Remove from the 'open' array
                detailRows.splice( idx, 1 );
            }
            else 
            {
                tr.addClass( 'details' );
                row.child( format_job_details( row.data() ) ).show();

                // Add to the 'open' array
                if ( idx === -1 ) 
                {
                    detailRows.push( tr.attr('id') );
                }
            }
        });
 
        // On each draw, loop over the `detailRows` array and show any child rows
        $finished_table.on( 'draw', function () 
        {
            $.each( detailRows, function ( i, id ) 
            {
                $('#'+id+' td.details-control').trigger( 'click' );
            });
        });
        
        //var poll = setInterval('$("#process_node_table").dataTable().fnDraw()', 3000);
    });
    </script>
    <title> MapsPy Scheduler </title>
  </head>
  <body>
    <div id="process_nodes_div">
        <table id="process_node_table">
       <!-- <tr class="header">  -->
         <thead>
           <tr>
            <th></th>
            <th>Computer Name </th>
            <th>Status</th>
            <th>Max Threads</th>
            <th>Heartbeat</th>
           </tr>
         </thead>
        </table>
     </div>
      <br>
      <br>
     <div id="jobs_div">
    <table id="table_unprocessed_jobs" class="display">
        <thead>
        <tr>
            <th></th>
            <th>Queued Jobs</th>
            <th>Path</th>
            <th>Status</th>
            <th>Analysis</th>
        </tr>
        </thead>
    </table>
    <br>
    <table id="table_processing_jobs" class="display">
        <thead>
        <tr>
            <th></th>
            <th>Processing Jobs</th>
            <th>Path</th>
            <th>Status</th>
            <th>Analysis</th>
        </tr>
        </thead>
    </table>
    <br>
    <table id="table_finished_jobs" class="display">
        <thead>
        <tr>  
            <th></th>
            <th>Finished Jobs</th>
            <th>Path</th>
            <th>Status</th>
            <th>Analysis</th>
        </tr>
        </thead>
    <!--    <tbody id="data_finished_jobs"> <tbody> -->
    </table>
     </div>


    <div class="tabs">
    <ul class="tab-links">
        <li class="active"><a href="#tab1">2-ID-E</a></li>
        <li><a href="#tab2">2-ID-D</a></li>
    </ul>
 
    <div class="tab-content">
        <div id="tab1" class="tab active">
            <p>2-ID-E</p>

        <!--   <form> -->
             <fieldset>
               <legend>Job Information:</legend>
               Job Path:
               <input type="text" id="DataPath" value="/"> <button id='Btn-Brouse-2IDE'>Browse</button>
               <div id="browse-jobs" class="overlay">
                    <div class="popup">
                        <h2>Jobs</h2>
                        <a class="close" href="/">&times;</a>
                        <div class="content"> 
                            <div id='jstree'>

                            </div>
                        </div>
                        <button id='Btn-Select-Dir'>Select</button>
                    </div>
                </div>
               <br>
               <input type="checkbox" id="analysis-type-a" value="A">A<br>
               <input type="checkbox" id="analysis-type-b" value="B">B<br>
               <input type="checkbox" id="analysis-type-c" value="C">C<br>
               <input type="checkbox" id="analysis-type-d" value="D">D<br>
               <input type="checkbox" id="analysis-type-e" value="E">E<br>
               Total Number of Detectors:
               <input type="text" id="option-detector-elements" value="4"><br>
               Number Processors Per File:
               <input type="text" id="option-proc-per-file" value="1">
               Number Processors Per Line:
               <input type="text" id="opiton-proc-per-line" value="1"><br>
               <input type="checkbox" id="option-quick-and-dirty">Quick and Dirty
               <input type="checkbox" id="option-xrf-bin">XRF Bin
               <input type="checkbox" id="option-nnls">NNLS
               <input type="checkbox" id="option-xanes">XANES Scan
<!--
            write_hdf = 0
            detector_to_start_with = 0
            priority = 5 
-->
               <br><br>
               <button id="Btn-Submit-Job">Submit Job</button>
             </fieldset>
         </div>
 
        <div id="tab2" class="tab">
            <p>2-ID-D</p>
            <p>Submit Job</p>
        </div>
 
    </div>
    </div>

    
  </body>
</html>
